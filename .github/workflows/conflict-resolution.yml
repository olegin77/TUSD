name: Conflict Resolution

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  # –ë–ª–æ–∫ schedule —É–¥–∞–ª–µ–Ω, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∞–º –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-conflicts:
    runs-on: ubuntu-latest
    outputs:
      has-conflicts: ${{ steps.detect.outputs.has-conflicts }}
      conflict-files: ${{ steps.detect.outputs.conflict-files }}
      pr-number: ${{ steps.detect.outputs.pr-number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect merge conflicts
        id: detect
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä PR –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            BASE_REF="${{ github.event.pull_request.base.ref }}"
          else
            # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (workflow_dispatch)
            echo "Manual run detected without PR context. Exiting."
            exit 0
          fi

          echo "Checking PR #$PR_NUMBER for conflicts"
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # –û–±–Ω–æ–≤–ª—è–µ–º main –≤–µ—Ç–∫—É
          git fetch origin main
          git checkout main
          git pull origin main

          # –ü–æ–ª—É—á–∞–µ–º feature –≤–µ—Ç–∫—É
          git fetch origin $HEAD_REF

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º –æ—à–∏–±–∫–∏ –≤—ã—Ö–æ–¥–∞ (set +e –≤–Ω—É—Ç—Ä–∏ if)
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º merge-tree –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–ª–∏—è–Ω–∏—è
          if git merge-tree $(git merge-base origin/main origin/$HEAD_REF) origin/main origin/$HEAD_REF > /tmp/merge-result 2>&1; then
            echo "No conflicts detected"
            echo "has-conflicts=false" >> $GITHUB_OUTPUT
            echo "conflict-files=" >> $GITHUB_OUTPUT
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, —á—Ç–æ–±—ã grep –Ω–µ —É—Ä–æ–Ω–∏–ª —Å–∫—Ä–∏–ø—Ç (exit code 1)
            if grep -qE '^<<<<<<<|^=======|^>>>>>>>' /tmp/merge-result; then
                echo "Conflicts detected"
                echo "has-conflicts=true" >> $GITHUB_OUTPUT
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
                CONFLICT_FILES=$(grep -E '^<<<<<<<|^=======|^>>>>>>>' /tmp/merge-result | grep -o '^[^:]*' | sort -u | tr '\n' ',' | sed 's/,$//')
                echo "conflict-files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
                echo "Conflict files: $CONFLICT_FILES"
            else
                echo "Merge failed but no standard conflict markers found. Check logs."
                echo "has-conflicts=false" >> $GITHUB_OUTPUT
            fi
          fi

  attempt-auto-resolution:
    runs-on: ubuntu-latest
    needs: detect-conflicts
    if: needs.detect-conflicts.outputs.has-conflicts == 'true'
    outputs:
      resolution-success: ${{ steps.resolve.outputs.success }}
      resolution-message: ${{ steps.resolve.outputs.message }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Attempt auto-resolution
        id: resolve
        run: |
          PR_NUMBER="${{ needs.detect-conflicts.outputs.pr-number }}"
          CONFLICT_FILES="${{ needs.detect-conflicts.outputs.conflict-files }}"

          echo "Attempting to resolve conflicts for PR #$PR_NUMBER"
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ PR
          PR_INFO=$(gh pr view $PR_NUMBER --json title,headRefName,baseRefName,author)
          HEAD_REF=$(echo $PR_INFO | jq -r '.headRefName')
          BASE_REF=$(echo $PR_INFO | jq -r '.baseRefName')
          AUTHOR=$(echo $PR_INFO | jq -r '.author.login')

          # –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É
          RESOLUTION_BRANCH="conflict-resolution-$PR_NUMBER-$(date +%s)"
          git fetch origin $HEAD_REF
          git checkout -b $RESOLUTION_BRANCH origin/$HEAD_REF

          # –ü—Ä–æ–±—É–µ–º –º–µ—Ä–∂–∏—Ç—å main
          git fetch origin main
          # –ü—ã—Ç–∞–µ–º—Å—è –º–µ—Ä–∂–∏—Ç—å, –æ–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É, –ø–æ—ç—Ç–æ–º—É || true
          git merge origin/main || true

          RESOLUTION_SUCCESS="true"
          RESOLUTION_MESSAGE=""

          # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ö–æ–Ω—Ñ–∏–≥–∏ (ours)
          if echo "$CONFLICT_FILES" | grep -qE '\.(json|yml|yaml|toml|lock)$'; then
            echo "Resolving config files..."
            # –ù–∞—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
            git diff --name-only --diff-filter=U | grep -E '\.(json|yml|yaml|toml|lock)$' | while read file; do
                git checkout --ours "$file"
                git add "$file"
                echo "Resolved $file using 'ours'"
            done
          fi

          # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã (theirs)
          if echo "$CONFLICT_FILES" | grep -qE '(dist/|build/|generated/)'; then
             echo "Resolving generated files..."
             git diff --name-only --diff-filter=U | grep -E '(dist/|build/|generated/)' | while read file; do
                git checkout --theirs "$file"
                git add "$file"
                echo "Resolved $file using 'theirs'"
             done
          fi

          # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á—É
          if git diff --check > /dev/null 2>&1; then
            echo "All specified conflicts resolved"
            RESOLUTION_MESSAGE="‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏/—Å–±–æ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
            
            git commit -m "ü§ñ Auto-resolve merge conflicts
            
            Co-authored-by: $AUTHOR <$AUTHOR@users.noreply.github.com>"
            
            git push origin $RESOLUTION_BRANCH:$HEAD_REF
          else
            echo "Unresolved conflicts remain"
            RESOLUTION_SUCCESS="false"
            RESOLUTION_MESSAGE="‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–∏–∫–∏."
            # –û—Ç–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –º—É—Å–æ—Ä
            git merge --abort || true
          fi

          echo "success=$RESOLUTION_SUCCESS" >> $GITHUB_OUTPUT
          echo "message=$RESOLUTION_MESSAGE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-resolution:
    runs-on: ubuntu-latest
    needs: [detect-conflicts, attempt-auto-resolution]
    if: always() && needs.detect-conflicts.outputs.has-conflicts == 'true'
    steps:
      - name: Notify about resolution
        run: |
          PR_NUMBER="${{ needs.detect-conflicts.outputs.pr-number }}"
          RESOLUTION_SUCCESS="${{ needs.attempt-auto-resolution.outputs.resolution-success }}"
          
          if [ "$RESOLUTION_SUCCESS" = "true" ]; then
             BODY="‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!**\n\n–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏–ª–∞ –≤–µ—Ç–∫—É, —Ä–∞–∑—Ä–µ—à–∏–≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏/—Å–±–æ—Ä–∫–∏."
          else
             BODY="‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**\n\n–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–º–æ–≥–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–¥–µ–ª–∞–π—Ç–µ \`git pull origin main\` –≤ –≤–∞—à–µ–π –≤–µ—Ç–∫–µ."
          fi
            
          gh pr comment $PR_NUMBER --body "$BODY"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    runs-on: ubuntu-latest
    needs: [detect-conflicts, attempt-auto-resolution]
    if: always() && needs.attempt-auto-resolution.result == 'success'
    steps:
      - name: Cleanup
        run: echo "Cleanup skipped as no artifacts were stored permanently."
