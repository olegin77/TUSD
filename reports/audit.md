# Проектный аудит (репозиторий + продакшн)

## Резюме

- Репозиторий активен (ветка `work`), но критические регрессы блокируют выпуск: юнит-тесты индексера падают на инициализации TronWeb, а Next.js билд веб-клиента обрывается на загрузке шрифта Google Fonts — оба дефекта стопорят CI/CD и окружения (P0). (см. `reports/artifacts/20251111-140553/coverage` и логи `pnpm --filter webapp build`).
- Продакшн-URL возвращает 403 Forbidden для всех основных путей, доступ к приложению отсутствует (P0). (`reports/artifacts/20251111-140553/prod-headers.txt`, `headers-*.txt`).
- Инфраструктурные проверки (E2E, Lighthouse, audit) сорваны из-за сетевых ограничений и отсутствующих утилит; требуется восстановить tooling и прокси-настройки (P1).
- Тестовое покрытие backend-а 3.55% с двумя падающими тестами; фронт/индексер не проходят сборку/сидинг, что указывает на незавершённую интеграцию и долги (P1).

Приоритеты:

- **P0**: Восстановить доступность продакшна; починить TronWeb-инициализацию и Next build.
- **P1**: Обновить пайплайн (typecheck, format), устранить блоки сетевой инфраструктуры, добиться прохождения сидов/миграций.
- **P2**: Повысить покрытие и закрыть технические долги (a11y/SEO, безопасность) после восстановления базовой функциональности.

## Репозиторий

- Ветка `work`, последние коммиты — серия фиксов Tron-интеграции и рефакторинга (см. `git log` в `reports/artifacts/20251111-140553/doc-summary.txt`).
- Линтеры (`pnpm -r run lint`) отрабатывают успешно для `apps/indexer` и `apps/webapp`, ошибок не обнаружено (`chunk 64ba18`). Скриптов `format:check` и `typecheck` нет — пайплайн не контролирует форматирование/TS-типизацию (`chunks ffd05a`, `144f97`).
- `pnpm prisma generate` не найден (CLI отсутствует в workspace) — индексация Prisma схемы не автоматизирована (`chunk ed8e2d`).
- Юнит-тесты: `apps/indexer` падает — `TronWeb is not a constructor`, статусы сервиса остаются `isRunning=false`. Покрытие по всему приложению 3.55%/3.21%/2.28%/3.28%, большинство модулей без тестов (`chunks b3a3be`, `78e6b4`, артефакт `reports/artifacts/20251111-140553/coverage`).
- Seeds: `pnpm -r run db:seed` завершается ошибкой `ts-node prisma/seed.ts` (скорее всего отсутствие Prisma env/подключения) (`chunk 065474`).
- Сборка: `next build` ломается на загрузке шрифта Inter (нет доступа к fonts.googleapis.com), повторные попытки не помогают — нужен оффлайн fallback или локальный шрифт (`chunks f87ae2`, `8bb34e`, `63e939`, `013d47`). `pnpm -r run start` также падает (build не собран) (`chunk 874418`). Dev-режим стартует локально (`chunk 8d0e78`).
- Безопасность/зависимости: `pnpm audit` возвращает 403 Forbidden (npm registry заблокирован), `npm audit` отказывает без package-lock, `license-checker` также 403 (`chunks 4c42d8`, `bd7013`, `cebb44`). Требуется настроить доступ к registry или использовать зеркала.

## Продакшн (URL)

- Все HTTP-запросы (/, /favicon.ico, /robots.txt) получают 403 Forbidden от Envoy (`reports/artifacts/20251111-140553/prod-headers.txt`, `headers-*.txt`, chunk `7a225f`). Контент — строка `Forbidden`, других ресурсов нет (`chunk d57e9a`). Требуется проверить ACL, firewall, маршрутизацию или прогрев приложения.
- Broken-link check не запущен — установка `broken-link-checker` через npm блокирована 403 (`chunk 6355e8`).
- Lighthouse не установлен (команда `lighthouse` отсутствует; глобальная установка через npm блокирована) (`chunk 6286bf`).

## E2E-поведение

- Playwright не установился/не запустился из-за 403 на `playwright` пакет в npm (`chunks 9bba02`, `7766d9`). Скрипт смоук-тестов создан (`e2e-smoke.spec.ts`), но отчёт пустой (`reports/artifacts/20251111-140553/pw-report.json` не сгенерирован). Требуется локальный cache или приватный регистр.
- UI ручная проверка невозможна из-за 403 на продакшне и отсутствующего локального билда.

## API

- Автоматический поиск swagger/openapi не выполнен: `ripgrep` отсутствует в окружении (apt 403), поэтому `api-greps.txt` пустой (`chunks 497275`, `a0145e`, артефакт `reports/artifacts/20251111-140553/api-greps.txt`).
- Дымовые HTTP-вызовы из документации не выполнялись (нет списка URL из-за ошибки ripgrep); `reports/artifacts/20251111-140553/api-smoke.txt` отсутствует.
- По коду (NestJS модули в `apps/indexer/src/modules/**`) видно множество контроллеров (admin, auth, deposits и т.д.), но без успешного запуска/seed проверить их нельзя. Требуется актуализировать Swagger и добавить e2e/contract-тесты.

## Безопасность/инфра

- Обновление пакетных репозиториев apt завершается 403 (прокси/зеркало недоступно), что блокирует установку jq/docker/trivy и других утилит (`chunk aeb52d`). `python3-pip` и `default-jre` не найдены (`chunk c71767`). Установка Docker через curl — 403 (`chunk cebb85`).
- Docker Compose не запускался (нет `docker-compose.yml`). Trivy не применён.
- `pnpm audit`/`license-checker`/`broken-link-checker`/`playwright`/`lighthouse` все упали из-за 403 — необходимо восстановить доступ к npm registry (настроить npmrc, Artifactory или offline зеркала).
- Dev сервер поднимается, но без проверок миграций и seed (ошибка `ts-node prisma/seed.ts`). Логи `reports/artifacts/20251111-140553/dev.log` показывают, что Next.js dev готов к тестам, однако без успешных билдов/тестов CI нестабилен.

## Рекомендации

- **P0**: Проверить инфраструктуру продакшна (Envoy/ingress) и восстановить HTTP 200. Настроить TronWeb mocks или обновить имплементацию, чтобы `TronWeb` корректно инициализировался в тестах. Добавить локальный fallback для шрифтов (`next/font/local`) или проксировать Google Fonts.
- **P1**: Добавить скрипты `format:check`, `typecheck`, обеспечить доступ к npm/apt (через корпоративное зеркало), восстановить Prisma CLI и seed. Настроить CI для повторного выполнения lint/test/build, зафиксировать артефакты (`reports/artifacts/20251111-140553`).
- **P2**: Восстановить e2e/Lighthouse tooling, расширить тестовое покрытие (особенно модули Tron/Solana), внедрить Swagger/OpenAPI для backend, провести security review зависимостей после восстановления доступа к аудитам.
- **P3**: Документировать процессы запуска/деплоя (актуализация README), автоматизировать локальные сценарии (Makefile/Turbo pipelines), улучшить наблюдаемость (Prometheus/Sentry) как указано в ТЗ.
