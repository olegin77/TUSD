// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output = "../../../node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Payout frequency enum
enum PayoutFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

// Vault type enum (TAKARA rebrand: Pool → Vault)
enum VaultType {
  VAULT_1 // Starter (Laika Boost) - 12 months, $100 min
  VAULT_2 // Advanced (Takara Boost) - 30 months, $1500 min
  VAULT_3 // Whale (Takara Boost) - 36 months, $5000 min
}

// Batch status enum
enum BatchStatus {
  COLLECTING // Активный сбор средств
  FILLED     // Заполнен, начисление наград запущено
  COMPLETED  // Завершен
}

// Deposit status enum (Master v6 - Multi-chain flow)
enum DepositStatus {
  INITIAL          // Initial state - waiting for USDT deposit
  PENDING_BOOST    // USDT confirmed, waiting for boost token lock
  PENDING_MINT     // Ready to mint Wexel NFT
  ACTIVE           // Wexel minted, rewards accruing
  MATURED          // Lock period ended, can redeem
  REDEEMED         // NFT burned, principal returned
  USDT_TX_FAILED   // USDT transaction verification failed
  BOOST_TX_FAILED  // Boost token lock failed
  MINT_FAILED      // Wexel mint failed
  EXPIRED          // Timeout waiting for next step
}

// Boost token enum
enum BoostToken {
  LAIKA   // Vault 1: Laika boost (40% of deposit, market price - 15%)
  TAKARA  // Vault 2 & 3: Takara boost (1:1, fixed $0.10)
  NONE    // No boost selected
}

// Vault configuration (ex-Pool) - TAKARA rebrand
model Vault {
  id               Int         @id @default(autoincrement())
  name             String      // "Starter", "Advanced", "Whale"
  type             VaultType   // VAULT_1, VAULT_2, VAULT_3

  // Batch Logic
  batch_number     Int         @default(1) // Текущий активный номер батча (1-1, 1-2...)
  batch_status     BatchStatus @default(COLLECTING)
  current_liquidity Decimal    @default(0) @db.Decimal(18, 6)
  target_liquidity  Decimal    @default(100000) @db.Decimal(18, 6) // Лимит $100k для закрытия батча

  // Finance Params
  duration_months   Int        // 12, 30, 36
  min_entry_amount  Decimal    @db.Decimal(18, 6) // $100, $1500, $5000

  // Yield Params - USDT (Master v6 CORRECTED VALUES)
  base_usdt_apy     Float      // Base APY %: 7%, 7%, 8%
  boosted_usdt_apy  Float      // Max APY with boost: 8.4%, 13%, 15%

  // APY in basis points (for precision)
  base_apy_bps      Int        @default(0) // Base APY in bps: 700, 700, 800
  boost_apy_bps     Int        @default(0) // Boost APY in bps: 140, 600, 700
  max_apy_bps       Int        @default(0) // Max APY in bps: 840, 1300, 1500

  // Yield Params - Takara Mining
  takara_apr        Float      // APR: 30%, 30%, 40%
  takara_apr_bps    Int        @default(0) // APR in bps: 3000, 3000, 4000

  // Boost Conditions
  boost_token_symbol String    // "LAIKA" or "TAKARA"
  boost_ratio        Float     // 0.4 (40% для Laika) или 1.0 (1:1 для Takara)
  boost_discount     Float     @default(0) // 0.15 (15% скидка) для Laika, 0 для Takara
  boost_fixed_price  Decimal?  @db.Decimal(18, 8) // Фикс. цена $0.10 для Takara буста

  // Legacy fields for compatibility
  apy_base_bp      Int        @default(0) // Deprecated: use base_usdt_apy
  lock_months      Int        @default(12) // Deprecated: use duration_months
  min_deposit_usd  BigInt     @default(0) // Deprecated: use min_entry_amount
  total_liquidity  BigInt     @default(0) // Deprecated: use current_liquidity
  total_wexels     BigInt     @default(0) // Общее количество векселей
  boost_target_bp  Int        @default(3000) // Deprecated
  boost_max_bp     Int        @default(500) // Deprecated
  laika_boost_max  Float      @default(2) // Deprecated
  mining_allocation Decimal   @default(0) @db.Decimal(18, 6) // Добыто Takara

  is_active        Boolean    @default(true)
  created_at       DateTime   @default(now())
  updated_at       DateTime   @updatedAt

  // Relations
  wexels   Wexel[]
  deposits Deposit[]

  @@map("vaults")
}

// Wexel (NFT-вексель)
model Wexel {
  id                BigInt   @id @default(autoincrement())
  owner_solana      String? // Solana адрес владельца
  owner_tron        String? // Tron адрес владельца
  vault_id          Int      // TAKARA: renamed from pool_id
  vault_batch_number Int     @default(1) // Номер батча в который попал вексель
  principal_usd     BigInt // Основная сумма в USDT (в микро-единицах)
  apy_base_bp       Int // Базовый APY в базисных пунктах
  apy_boost_bp      Int      @default(0) // Буст APY в базисных пунктах
  start_ts          DateTime // Время начала
  end_ts            DateTime // Время окончания
  is_collateralized Boolean  @default(false) // В залоге ли
  total_claimed_usd BigInt   @default(0) // Общая сумма выплат
  nft_mint_address  String? // Адрес NFT mint (Solana)
  nft_token_address String? // Адрес NFT токена (Tron)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  vault               Vault               @relation(fields: [vault_id], references: [id])
  collateral_position CollateralPosition?
  listings            Listing[]
  claims              Claim[]
  boosts              Boost[]

  @@map("wexels")
}

// Залоговая позиция
model CollateralPosition {
  wexel_id   BigInt   @id // ID векселя
  loan_usd   BigInt // Сумма займа в USDT (в микро-единицах)
  start_ts   DateTime // Время начала залога
  repaid     Boolean  @default(false) // Погашен ли займ
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  wexel Wexel @relation(fields: [wexel_id], references: [id], onDelete: Cascade)

  @@map("collateral")
}

// Листинги на маркетплейсе
model Listing {
  id            BigInt    @id @default(autoincrement())
  wexel_id      BigInt
  ask_price_usd BigInt // Цена продажи в USDT (в микро-единицах)
  auction       Boolean   @default(false) // Аукцион или фиксированная цена
  min_bid_usd   BigInt? // Минимальная ставка для аукциона
  expiry_ts     DateTime? // Время истечения листинга
  status        String    @default("active") // active, sold, cancelled
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  wexel Wexel @relation(fields: [wexel_id], references: [id], onDelete: Cascade)

  @@map("listings")
}

// Выплаты наград
model Claim {
  id         BigInt   @id @default(autoincrement())
  wexel_id   BigInt
  amount_usd BigInt // Сумма выплаты в USDT (в микро-единицах)
  claim_type String // daily, final, partial
  tx_hash    String? // Хэш транзакции
  created_at DateTime @default(now())

  // Relations
  wexel Wexel @relation(fields: [wexel_id], references: [id], onDelete: Cascade)

  @@map("claims")
}

// Буст-монеты
model Boost {
  id           BigInt   @id @default(autoincrement())
  wexel_id     BigInt
  token_mint   String // Адрес токена буста
  amount       BigInt // Количество токенов
  value_usd    BigInt // Стоимость в USD на момент добавления
  apy_boost_bp Int // Добавленный APY в базисных пунктах
  price_usd    BigInt // Цена токена в USD на момент добавления
  created_at   DateTime @default(now())

  // Relations
  wexel Wexel @relation(fields: [wexel_id], references: [id], onDelete: Cascade)

  @@map("boosts")
}

// Депозиты (Master v6 - Multi-chain deposit flow)
model Deposit {
  id                    BigInt        @id @default(autoincrement())
  vault_id              Int           // Vault ID
  vault_batch_number    Int           @default(1) // Batch number at deposit time

  // User Wallets (Multi-chain)
  user_tron_address     String        @db.VarChar(42)  // TRC20 address for USDT deposit
  user_solana_address   String        @db.VarChar(44)  // Solana pubkey for rewards/NFT
  current_owner_solana  String        @db.VarChar(44)  // Can change if NFT transferred!

  // Deposit Amount
  amount_usd            Decimal       @db.Decimal(18, 6)  // Amount in USDT

  // Status (Multi-chain flow states)
  deposit_status        DepositStatus @default(INITIAL)

  // Transaction Hashes (Multi-chain)
  tron_tx_hash          String?       @db.VarChar(64)  // USDT deposit tx on TRON
  tron_tx_confirmed     Boolean       @default(false)
  boost_tx_signature    String?       @db.VarChar(88)  // Boost lock tx on Solana
  boost_tx_confirmed    Boolean       @default(false)
  mint_tx_signature     String?       @db.VarChar(88)  // Wexel mint tx on Solana

  // Wexel NFT
  wexel_mint_address    String?       @db.VarChar(44)  // Solana NFT mint address
  wexel_metadata_uri    String?       // Arweave/IPFS URI

  // APY Configuration (frozen at deposit time)
  base_apy_bps          Int           @default(0)      // Base APY in basis points
  boost_apy_bps         Int           @default(0)      // Boost APY in basis points
  total_apy_bps         Int           @default(0)      // base + boost
  frequency_multiplier  Decimal       @default(1.0) @db.Decimal(4, 2)  // 1.0, 1.15, 1.30
  effective_apy_bps     Int           @default(0)      // total * multiplier
  payout_frequency      PayoutFrequency @default(MONTHLY)

  // Boost Details
  boost_token           BoostToken    @default(NONE)
  boost_token_mint      String?       @db.VarChar(44)  // Laika or Takara mint
  boost_token_amount    Decimal?      @db.Decimal(18, 9)
  boost_token_locked    Boolean       @default(false)
  boost_price_at_deposit Decimal?     @db.Decimal(18, 8)  // Price used for calculation

  // Takara Mining Rewards
  takara_mining_apr_bps Int           @default(0)      // APR for Takara mining
  takara_pending        Decimal       @default(0) @db.Decimal(18, 9)
  takara_claimed_total  Decimal       @default(0) @db.Decimal(18, 9)
  last_takara_claim_at  DateTime?

  // USDT Rewards
  usdt_claimed_total    Decimal       @default(0) @db.Decimal(18, 6)
  last_usdt_claim_at    DateTime?

  // Timing
  lock_start_at         DateTime?
  lock_end_at           DateTime?
  is_matured            Boolean       @default(false)
  is_redeemed           Boolean       @default(false)
  redeemed_at           DateTime?

  // Security (anti-replay)
  claim_nonce           Int           @default(0)

  // Legacy compatibility fields
  user_address          String?       // Deprecated: use user_tron_address
  wexel_id              BigInt?       // Legacy wexel reference
  tx_hash               String?       // Deprecated: use tron_tx_hash
  status                String        @default("pending") // Legacy: use deposit_status
  is_takara_boosted     Boolean       @default(false)
  is_laika_boosted      Boolean       @default(false)
  network               String        @default("TRON")
  solana_wallet         String?       // Deprecated: use user_solana_address

  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  // Relations
  vault                 Vault         @relation(fields: [vault_id], references: [id])

  @@index([user_tron_address])
  @@index([user_solana_address])
  @@index([current_owner_solana])
  @@index([wexel_mint_address])
  @@index([deposit_status])
  @@index([vault_id, deposit_status])
  @@map("deposits")
}

// Пользователи
model User {
  id              BigInt   @id @default(autoincrement())
  solana_address  String?  @unique // Solana адрес
  tron_address    String?  @unique // Tron адрес
  email           String?  @unique // Email для уведомлений
  telegram_id     String?  @unique // Telegram ID
  is_kyc_verified Boolean  @default(false) // KYC статус
  is_active       Boolean  @default(true) // Активен ли пользователь
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("users")
}

// Цены токенов (кеш оракулов)
model TokenPrice {
  id         BigInt   @id @default(autoincrement())
  token_mint String   @unique // Адрес токена
  price_usd  BigInt // Цена в USD (в микро-единицах)
  source     String // Источник цены (pyth, chainlink, dex, cex)
  updated_at DateTime @updatedAt

  @@map("token_prices")
}

// События блокчейна (для индексации)
model BlockchainEvent {
  id         BigInt   @id @default(autoincrement())
  chain      String // solana, tron
  tx_hash    String // Хэш транзакции
  event_type String // deposit, boost, claim, collateralize, etc.
  data       Json // Данные события
  processed  Boolean  @default(false) // Обработано ли событие
  created_at DateTime @default(now())

  @@map("blockchain_events")
}

// Маркетплейс (для совместимости)
model Marketplace {
  id         BigInt   @id @default(autoincrement())
  item_type  String // "wexel" | "loan"
  item_id    BigInt // ID векселя или займа
  seller     String // Адрес продавца
  price_usd  BigInt // Цена в USDT (микро-единицы)
  status     String // "active" | "sold" | "cancelled"
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("marketplace")
}

// ========================================
// TRON INTEGRATION MODELS
// ========================================

// Tron deposits tracking
model TronDeposit {
  id           BigInt   @id @default(autoincrement())
  deposit_id   String   @unique
  depositor    String // Tron address
  vault_id     Int      // TAKARA: renamed from pool_id
  vault_batch  Int      @default(1) // Номер батча
  amount       String // USDT amount in string (handles large numbers)
  solana_owner String // Target Solana address
  timestamp    DateTime
  tx_hash      String // Tron transaction hash
  processed    Boolean  @default(false)
  wexel_id     String? // Linked Wexel ID after minting
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([depositor])
  @@index([solana_owner])
  @@index([processed])
  @@index([timestamp])
  @@index([vault_id])
  @@map("tron_deposits")
}

// Cross-chain messaging
model CrossChainMessage {
  id                     BigInt   @id @default(autoincrement())
  message_id             String   @unique
  message_type           String // "DEPOSIT" | "WITHDRAWAL" | "PRICE_UPDATE"
  source_chain           String // "TRON" | "SOLANA"
  target_chain           String // "TRON" | "SOLANA"
  sender                 String // Address of sender
  payload                Json // Message payload
  status                 String   @default("pending") // "pending" | "confirmed" | "completed" | "failed"
  confirmations          Int      @default(0)
  required_confirmations Int      @default(2)
  processed              Boolean  @default(false)
  tx_hash_source         String? // Transaction hash on source chain
  tx_hash_target         String? // Transaction hash on target chain
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@index([source_chain])
  @@index([target_chain])
  @@index([status])
  @@index([processed])
  @@map("cross_chain_messages")
}

// Tron indexer state tracking
model TronIndexerState {
  id           Int      @id @default(autoincrement())
  last_block   BigInt   @default(0)
  last_updated DateTime @default(now()) @updatedAt

  @@map("tron_indexer_state")
}

// ========================================
// TAKARA TOKEN CONFIGURATION
// ========================================

// Takara token global configuration
model TakaraConfig {
  id                     Int      @id @default(1)
  internal_price_usd     Decimal  @db.Decimal(18, 8) // Внутренний курс Takara для расчетов
  total_supply           Decimal  @db.Decimal(18, 6) // Общий саплай токена
  mining_pool_total      Decimal  @db.Decimal(18, 6) // 60% от саплая для майнинга
  mining_pool_remaining  Decimal  @db.Decimal(18, 6) // Остаток в пуле майнинга
  mining_pool_distributed Decimal @default(0) @db.Decimal(18, 6) // Распределено из пула
  token_mint_address     String?  // Адрес Takara mint на Solana
  mining_vault_address   String?  // Адрес MiningVault PDA на Solana
  admin_wallet_address   String?  // Адрес админ кошелька (40% саплая)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("takara_config")
}

// Takara reward claims history
model TakaraClaimHistory {
  id              BigInt   @id @default(autoincrement())
  deposit_id      BigInt   // ID депозита
  user_address    String   // Solana адрес пользователя
  amount          Decimal  @db.Decimal(18, 6) // Количество Takara
  price_at_claim  Decimal  @db.Decimal(18, 8) // Курс на момент клейма
  tx_hash         String?  // Хэш транзакции на Solana
  status          String   @default("pending") // pending, confirmed, failed
  created_at      DateTime @default(now())

  @@index([deposit_id])
  @@index([user_address])
  @@map("takara_claim_history")
}

// Laika boost snapshots for deposits
model LaikaBoostSnapshot {
  id                  BigInt   @id @default(autoincrement())
  deposit_id          BigInt   @unique // ID депозита
  laika_balance       Decimal  @db.Decimal(18, 6) // Баланс Laika на момент проверки
  laika_price_usd     Decimal  @db.Decimal(18, 8) // Цена Laika (рыночная)
  laika_price_discounted Decimal @db.Decimal(18, 8) // Цена с -15% дисконтом
  laika_value_usd     Decimal  @db.Decimal(18, 6) // Стоимость в USD
  deposit_amount_usd  Decimal  @db.Decimal(18, 6) // Сумма депозита
  threshold_40_pct    Decimal  @db.Decimal(18, 6) // 40% от депозита (порог)
  is_boost_eligible   Boolean  @default(false) // Проходит ли проверку
  checked_at          DateTime @default(now())

  @@index([deposit_id])
  @@map("laika_boost_snapshots")
}
